<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Добавить объект</title>
<link rel="stylesheet" href="./style.css">
</head>
<body>

<div class="container">

<header class="app-header">
<a href="index.html" class="header-back">←</a>
<div class="header-title">Новый объект</div>
</header>

<div class="form-wrapper">

<input id="title" class="form-input" placeholder="Название">
<input id="price" type="number" class="form-input" placeholder="Цена">
<textarea id="description" class="form-input" placeholder="Описание"></textarea>
<input id="address" class="form-input" placeholder="Адрес">

<select id="category" class="form-input">
<option>Подвал</option>
<option>1 этаж</option>
<option>Магазин</option>
</select>

<input type="file" id="images" multiple class="form-input">
<div id="preview" class="image-preview-grid"></div>

<button class="submit-btn" onclick="createObject()">
Сохранить объект
</button>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
const API = "https://api.evgeny-ivanov-premises.ru";

async function checkAuth() {
  const res = await fetch(API + "/check-auth", {
    credentials: "include"
  });

  if (!res.ok) {
    window.location.href = "login.html";
  }
}
checkAuth();

let imageFiles = [];
const preview = document.getElementById("preview");

/* ===== Sortable ===== */
new Sortable(preview, {
  animation: 150,
  onEnd: function () {
    const newOrder = [];
    preview.querySelectorAll(".preview-item").forEach(item => {
      const index = item.dataset.index;
      newOrder.push(imageFiles[index]);
    });
    imageFiles = newOrder;
    renderPreview();
  }
});

/* ===== Загрузка файлов ===== */
document.getElementById("images").addEventListener("change", function() {
  imageFiles = Array.from(this.files);
  renderPreview();
});

/* ===== Превью (как в редактировании) ===== */
function renderPreview() {
  preview.innerHTML = "";

  imageFiles.forEach((file, index) => {
    const reader = new FileReader();

    reader.onload = e => {
      const div = document.createElement("div");
      div.className = "preview-item";
      div.dataset.index = index;

      div.innerHTML = `
        <img src="${e.target.result}">
        <button type="button" class="remove-btn" onclick="removeImage(${index})">×</button>
      `;

      preview.appendChild(div);
    };

    reader.readAsDataURL(file);
  });
}

function removeImage(index) {
  imageFiles.splice(index, 1);
  renderPreview();
}

/* ===== Создание объекта ===== */
async function createObject() {

  if (!title.value || !price.value) {
    alert("Заполните название и цену");
    return;
  }

  const formData = new FormData();

  formData.append("title", title.value);
  formData.append("price", price.value);
  formData.append("description", description.value);
  formData.append("address", address.value);
  formData.append("category", category.value);

  imageFiles.forEach(file => {
    formData.append("images", file);
  });

  try {

    const res = await fetch(API + "/objects", {
      method: "POST",
      body: formData,
      credentials: "include"
    });

    if (!res.ok) {
      const errorText = await res.text();
      console.error("CREATE ERROR:", errorText);
      alert("Ошибка создания объекта");
      return;
    }

    window.location.href = "index.html";

  } catch (err) {
    console.error("CREATE FETCH ERROR:", err);
    alert("Сервер недоступен");
  }
}
</script>

</body>
</html>