<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Админ панель</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>

<div class="container">

  <header class="app-header">
    <div class="header-title">Админ панель</div>
  </header>

  <!-- Плавающий плюс -->
  <a href="create.html" class="floating-add">+</a>

  <!-- КАТЕГОРИИ -->
  <div class="category-nav">
    <button class="category-link active" data-category="Подвал">Подвалы</button>
    <button class="category-link" data-category="1 этаж">1 этаж</button>
    <button class="category-link" data-category="Магазин">Магазины</button>
  </div>

  <!-- СПИСОК -->
  <div class="properties-grid" id="objectsContainer"></div>

</div>

<script>
const API = "/api";
let allObjects = [];
let currentCategory = "Подвал";

/* ================= LOAD ================= */

async function loadObjects() {
  const res = await fetch(API + "/objects");
  const data = await res.json();
  allObjects = data;
  renderObjects();
}

/* ================= RENDER ================= */

function renderObjects() {
  const container = document.getElementById("objectsContainer");
  container.innerHTML = "";

  const filtered = allObjects.filter(o => o.category === currentCategory);

  filtered.forEach(obj => {

    const card = document.createElement("div");
    card.className = "property-card";

    card.innerHTML = `
      <div class="property-info">

        <h3 contenteditable="true"
            onblur="updateField(${obj.id}, 'title', this.innerText)">
          ${obj.title}
        </h3>

        <div class="address"
             contenteditable="true"
             onblur="updateField(${obj.id}, 'address', this.innerText)">
          ${obj.address || ""}
        </div>

        <div class="description"
             contenteditable="true"
             onblur="updateField(${obj.id}, 'description', this.innerText)">
          ${obj.description || ""}
        </div>

        <div class="property-price"
             contenteditable="true"
             onblur="updateField(${obj.id}, 'price', this.innerText.replace(/[^0-9]/g,''))">
          ${Number(obj.price).toLocaleString()} ₽
        </div>

        <br>
        <button class="delete-btn" onclick="deleteObject(${obj.id})">
          Удалить
        </button>

      </div>
    `;

    container.appendChild(card);
  });
}

/* ================= CATEGORY ================= */

document.querySelectorAll(".category-link").forEach(btn => {
  btn.addEventListener("click", () => {

    document.querySelectorAll(".category-link")
      .forEach(b => b.classList.remove("active"));

    btn.classList.add("active");

    currentCategory = btn.dataset.category;
    renderObjects();
  });
});

/* ================= UPDATE ================= */

async function updateField(id, field, value) {

  const object = allObjects.find(o => o.id === id);

  const updated = {
    title: object.title,
    price: object.price,
    description: object.description,
    address: object.address,
    category: object.category
  };

  updated[field] = value;

  await fetch(API + "/objects/" + id, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(updated)
  });

  loadObjects();
}

/* ================= DELETE ================= */

async function deleteObject(id) {
  await fetch(API + "/objects/" + id, {
    method: "DELETE"
  });

  loadObjects();
}

loadObjects();
</script>

</body>
</html>
