<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Админ панель</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>

<div class="container">

  <header class="app-header">
    <div class="header-title">Админ панель</div>
  </header>

  <a href="create.html" class="floating-add">+</a>

  <div class="category-nav">
    <button class="category-link active" data-category="Подвал">Подвалы</button>
    <button class="category-link" data-category="1 этаж">1 этаж</button>
    <button class="category-link" data-category="Магазин">Магазины</button>
  </div>

  <div class="properties-grid" id="objectsContainer"></div>

</div>

<script>
fetch("https://api.evgeny-ivanov-premises.ru/check-auth", {
  credentials: "include"
})
.then(res => {
  if (!res.ok) {
    window.location.href = "login.html";
  }
});

const API = "https://api.evgeny-ivanov-premises.ru";
let allObjects = [];
let currentCategory = "Подвал";

async function loadObjects() {
  const res = await fetch(API + "/objects");
  allObjects = await res.json();
  renderObjects();
}

function createSlider(images) {
  if (!images || images.length === 0) return "";

  return `
    <div class="property-slider">
      ${images.map((img, i) => `
        <img src="${API + img}" class="slide" style="display:${i === 0 ? 'block' : 'none'}">
      `).join("")}
      ${images.length > 1 ? `
        <button class="slider-btn prev">‹</button>
        <button class="slider-btn next">›</button>
      ` : ""}
    </div>
  `;
}

function activateSliders() {
  document.querySelectorAll(".property-slider").forEach(slider => {
    const slides = slider.querySelectorAll(".slide");
    let index = 0;

    const prev = slider.querySelector(".prev");
    const next = slider.querySelector(".next");

    function show(i) {
      slides.forEach(s => s.style.display = "none");
      slides[i].style.display = "block";
    }

    if (prev && next) {
      prev.onclick = e => {
        e.stopPropagation();
        index = (index - 1 + slides.length) % slides.length;
        show(index);
      };
      next.onclick = e => {
        e.stopPropagation();
        index = (index + 1) % slides.length;
        show(index);
      };
    }
  });
}

function renderObjects() {
  const container = document.getElementById("objectsContainer");
  container.innerHTML = "";

  const filtered = allObjects.filter(o => o.category === currentCategory);

  filtered.forEach(obj => {

    const card = document.createElement("div");
    card.className = "property-card";
    card.onclick = () => {
      window.location.href = `edit.html?id=${obj.id}`;
    };

    card.innerHTML = `
      ${createSlider(obj.images)}
      <div class="property-info">
        <h3>${obj.title}</h3>
        <div class="address">${obj.address || ""}</div>
        <div class="description">${obj.description || ""}</div>
        <div class="property-price">
          ${Number(obj.price).toLocaleString()} ₽
        </div>
      </div>
    `;

    container.appendChild(card);
  });

  activateSliders();
}

document.querySelectorAll(".category-link").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".category-link")
      .forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    currentCategory = btn.dataset.category;
    renderObjects();
  });
});

loadObjects();
</script>

</body>
</html>